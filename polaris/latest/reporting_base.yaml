---
apiVersion: v1
kind: Service
metadata:
  labels:
    environment: ${ENVIRONMENT_NAME}
  name: rp-frontend
  namespace: ${NAMESPACE}
spec:
  ports:
  - name: "80"
    port: 80
    targetPort: 8080
  selector:
    environment: ${ENVIRONMENT_NAME}
    name: rp-frontend
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    chart: rp-frontend
    chartVersion: 0.0.1771
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    name: rp-frontend
    service: rp-frontend
  name: rp-frontend
  namespace: ${NAMESPACE}
spec:
  replicas: 1
  selector:
    matchLabels:
      environment: ${ENVIRONMENT_NAME}
      name: rp-frontend
  template:
    metadata:
      labels:
        environment: ${ENVIRONMENT_NAME}
        name: rp-frontend
    spec:
      containers:
      - env:
        - name: REPORTING_STANDALONE
          value: "false"
        image: gcr.io/snps-swip-staging/reporting-frontend-service:0.0.1771
        imagePullPolicy: Always
        name: rp-frontend
        ports:
        - containerPort: 8080
        resources:
          limits:
            cpu: 500m
            memory: 500Mi
          requests:
            cpu: 250m
            memory: 256Mi
      imagePullSecrets:
      - name: ${IMAGE_PULL_SECRETS}
      restartPolicy: Always
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    chartVersion: 0.0.1080
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    service: rp-issue-manager
  name: rp-issue-manager
  namespace: ${NAMESPACE}
---
apiVersion: v1
kind: Service
metadata:
  labels:
    environment: ${ENVIRONMENT_NAME}
    name: rp-issue-manager
  name: rp-issue-manager
  namespace: ${NAMESPACE}
spec:
  ports:
  - name: "8080"
    port: 8080
    targetPort: 8080
  selector:
    environment: ${ENVIRONMENT_NAME}
    name: rp-issue-manager
status:
  loadBalancer: {}
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    chart: rp-issue-manager-service
    chartVersion: 0.0.1044
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    name: rp-issue-manager
    service: rp-issue-manager
  name: rp-issue-manager
  namespace: ${NAMESPACE}
spec:
  replicas: 1
  selector:
    matchLabels:
      environment: ${ENVIRONMENT_NAME}
      name: rp-issue-manager
  template:
    metadata:
      labels:
        environment: ${ENVIRONMENT_NAME}
        name: rp-issue-manager
    spec:
      containers:
      - env:
        - name: SWIP_VAULT_ADDRESS
          value: https://vault:8200
        - name: VAULT_CACERT
          value: /var/run/secrets/vault/ca/ca.crt
        - name: VAULT_CLIENT_KEY
          value: /var/run/secrets/vault/client/tls.key
        - name: VAULT_CLIENT_CERT
          value: /var/run/secrets/vault/client/tls.crt
        - name: POSTGRES_HOST
          valueFrom:
            configMapKeyRef:
              key: POSTGRESQL_HOST
              name: postgresql-config
        - name: POSTGRES_PORT
          valueFrom:
            configMapKeyRef:
              key: POSTGRESQL_PORT
              name: postgresql-config
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              key: POSTGRESQL_PASSWORD
              name: postgresql-config
        - name: POSTGRES_USERNAME
          valueFrom:
            secretKeyRef:
              key: POSTGRESQL_USER
              name: postgresql-config
        - name: CONNECTION_POOL_SIZE
          value: "10"
        - name: LOG_LEVEL
          value: INFO
        - name: SPRING_PROFILE
          value: production
        - name: SWIP_ENVIRONMENT_NAME
          value: ${ENVIRONMENT_NAME}
        - name: SWIP_ROOT_DOMAIN
          value: ${POLARIS_ROOT_DOMAIN}
        - name: REPORTING_STANDALONE
          value: <nil>
        - name: POSTGRES_SSL_MODE
          value: disable
        - name: POSTGRES_SSL_CERTIFICATE_SOURCE
          value: file-system
        - name: POSTGRES_SSL_TRUST_STORE_PATH
          value: ""
        image: gcr.io/snps-swip-staging/reporting-rp-issue-manager:0.0.1044
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /liveness
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 150
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 3
        name: rp-issue-manager
        ports:
        - containerPort: 8080
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /readiness
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 100
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        resources:
          limits:
            cpu: 750m
            memory: 1000Mi
          requests:
            cpu: 500m
            memory: 768Mi
        volumeMounts:
        - mountPath: /var/run/secrets/vault/client
          name: vault-client
          readOnly: true
        - mountPath: /var/run/secrets/vault/ca
          name: vault-server-ca
          readOnly: true
      imagePullSecrets:
      - name: ${IMAGE_PULL_SECRETS}
      restartPolicy: Always
      volumes:
      - name: vault-client
        secret:
          secretName: vault-read-only
      - name: vault-server-ca
        secret:
          defaultMode: 420
          secretName: vault-tls-certificate-new
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    chart: rp-polaris-agent-service
    chartVersion: 0.0.724
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    service: rp-polaris-agent-service
  name: rp-polaris-agent-service
  namespace: ${NAMESPACE}
---
apiVersion: v1
kind: Service
metadata:
  labels:
    environment: ${ENVIRONMENT_NAME}
    name: rp-polaris-agent-service
  name: rp-polaris-agent-service
  namespace: ${NAMESPACE}
spec:
  ports:
  - name: "8080"
    port: 8080
    targetPort: 8080
  selector:
    environment: ${ENVIRONMENT_NAME}
    name: rp-polaris-agent-service
status:
  loadBalancer: {}
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    chart: rp-polaris-agent-service
    chartVersion: 0.0.724
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    name: rp-polaris-agent-service
    service: rp-polaris-agent-service
  name: rp-polaris-agent-service
  namespace: ${NAMESPACE}
spec:
  replicas: 1
  selector:
    matchLabels:
      environment: ${ENVIRONMENT_NAME}
      name: rp-polaris-agent-service
  template:
    metadata:
      labels:
        environment: ${ENVIRONMENT_NAME}
        name: rp-polaris-agent-service
    spec:
      containers:
      - env:
        - name: SWIP_VAULT_ADDRESS
          value: https://vault:8200
        - name: VAULT_CACERT
          value: /var/run/secrets/vault/ca/ca.crt
        - name: VAULT_CLIENT_KEY
          value: /var/run/secrets/vault/client/tls.key
        - name: VAULT_CLIENT_CERT
          value: /var/run/secrets/vault/client/tls.crt
        - name: EVENT_STORE_ADDR
          value: eventstore.default.svc.cluster.local
        - name: EVENT_STORE_READER_USERNAME
          value: reader
        - name: EVENT_STORE_READER_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: swip-eventstore-reader-creds
        - name: CONNECTION_POOL_SIZE
          value: "10"
        - name: LOG_LEVEL
          value: INFO
        - name: SPRING_PROFILE
          value: production
        - name: SWIP_ENVIRONMENT_NAME
          value: ${ENVIRONMENT_NAME}
        - name: SWIP_ROOT_DOMAIN
          value: ${POLARIS_ROOT_DOMAIN}
        - name: REPORTING_STANDALONE
          value: "false"
        - name: POSTGRES_SSL_MODE
          value: disable
        - name: POSTGRES_SSL_CERTIFICATE_SOURCE
          value: file-system
        - name: POSTGRES_SSL_TRUST_STORE_PATH
          value: ""
        image: gcr.io/snps-swip-staging/reporting-polaris-service:0.0.724
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /liveness
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 120
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 3
        name: rp-polaris-agent-service
        ports:
        - containerPort: 8080
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /readiness
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 77
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        resources:
          limits:
            cpu: 750m
            memory: 1000Mi
          requests:
            cpu: 500m
            memory: 768Mi
        volumeMounts:
        - mountPath: /var/run/secrets/vault/client
          name: vault-client
          readOnly: true
        - mountPath: /var/run/secrets/vault/ca
          name: vault-server-ca
          readOnly: true
      imagePullSecrets:
      - name: ${IMAGE_PULL_SECRETS}
      restartPolicy: Always
      volumes:
      - name: vault-client
        secret:
          secretName: vault-read-only
      - name: vault-server-ca
        secret:
          defaultMode: 420
          secretName: vault-tls-certificate-new
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    chart: rp-portfolio-service
    chartVersion: 0.0.1056
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    service: rp-portfolio-service
  name: rp-portfolio-service
  namespace: ${NAMESPACE}
---
apiVersion: v1
kind: Service
metadata:
  labels:
    environment: ${ENVIRONMENT_NAME}
    name: rp-portfolio-service
  name: rp-portfolio-service
  namespace: ${NAMESPACE}
spec:
  ports:
  - name: "8080"
    port: 8080
    targetPort: 8080
  selector:
    environment: ${ENVIRONMENT_NAME}
    name: rp-portfolio-service
status:
  loadBalancer: {}
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    chart: rp-portfolio-service
    chartVersion: 0.0.1056
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    name: rp-portfolio-service
    service: rp-portfolio-service
  name: rp-portfolio-service
  namespace: ${NAMESPACE}
spec:
  replicas: 1
  selector:
    matchLabels:
      environment: ${ENVIRONMENT_NAME}
      name: rp-portfolio-service
  template:
    metadata:
      labels:
        environment: ${ENVIRONMENT_NAME}
        name: rp-portfolio-service
    spec:
      containers:
      - env:
        - name: SWIP_VAULT_ADDRESS
          value: https://vault:8200
        - name: VAULT_CACERT
          value: /var/run/secrets/vault/ca/ca.crt
        - name: VAULT_CLIENT_KEY
          value: /var/run/secrets/vault/client/tls.key
        - name: VAULT_CLIENT_CERT
          value: /var/run/secrets/vault/client/tls.crt
        - name: POSTGRES_HOST
          valueFrom:
            configMapKeyRef:
              key: POSTGRESQL_HOST
              name: postgresql-config
        - name: POSTGRES_PORT
          valueFrom:
            configMapKeyRef:
              key: POSTGRESQL_PORT
              name: postgresql-config
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              key: POSTGRESQL_PASSWORD
              name: postgresql-config
        - name: POSTGRES_USERNAME
          valueFrom:
            secretKeyRef:
              key: POSTGRESQL_USER
              name: postgresql-config
        - name: CONNECTION_POOL_SIZE
          value: "10"
        - name: LOG_LEVEL
          value: INFO
        - name: SPRING_PROFILE
          value: production
        - name: SWIP_ENVIRONMENT_NAME
          value: ${ENVIRONMENT_NAME}
        - name: SWIP_ROOT_DOMAIN
          value: ${POLARIS_ROOT_DOMAIN}
        - name: REPORTING_STANDALONE
          value: "false"
        - name: POSTGRES_SSL_MODE
          value: disable
        - name: POSTGRES_SSL_CERTIFICATE_SOURCE
          value: file-system
        - name: POSTGRES_SSL_TRUST_STORE_PATH
          value: ""
        image: gcr.io/snps-swip-staging/reporting-rp-portfolio-service:0.0.1056
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /liveness
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 120
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 3
        name: rp-portfolio-service
        ports:
        - containerPort: 8080
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /readiness
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 70
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        resources:
          limits:
            cpu: 750m
            memory: 1000Mi
          requests:
            cpu: 500m
            memory: 768Mi
        volumeMounts:
        - mountPath: /var/run/secrets/vault/client
          name: vault-client
          readOnly: true
        - mountPath: /var/run/secrets/vault/ca
          name: vault-server-ca
          readOnly: true
      imagePullSecrets:
      - name: ${IMAGE_PULL_SECRETS}
      restartPolicy: Always
      volumes:
      - name: vault-client
        secret:
          secretName: vault-read-only
      - name: vault-server-ca
        secret:
          defaultMode: 420
          secretName: vault-tls-certificate-new
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    chartVersion: 0.0.1231
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    service: rp-report-service
  name: rp-report-service
  namespace: ${NAMESPACE}
---
apiVersion: v1
kind: Service
metadata:
  labels:
    environment: ${ENVIRONMENT_NAME}
    name: report-storage
  name: report-storage
  namespace: ${NAMESPACE}
spec:
  ports:
  - port: 9000
    protocol: TCP
    targetPort: 9000
  selector:
    app: report-storage
    environment: ${ENVIRONMENT_NAME}
---
apiVersion: v1
kind: Service
metadata:
  labels:
    environment: ${ENVIRONMENT_NAME}
    name: rp-report-service
  name: rp-report-service
  namespace: ${NAMESPACE}
spec:
  ports:
  - name: "8080"
    port: 8080
    targetPort: 8080
  selector:
    environment: ${ENVIRONMENT_NAME}
    name: rp-report-service
status:
  loadBalancer: {}
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    chartVersion: 0.0.1231
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    name: report-storage
    service: report-storage
  name: report-storage
  namespace: ${NAMESPACE}
spec:
  selector:
    matchLabels:
      environment: ${ENVIRONMENT_NAME}
      name: report-storage
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: report-storage
        environment: ${ENVIRONMENT_NAME}
        name: report-storage
    spec:
      containers:
      - command:
        - /bin/sh
        - -ce
        - /usr/bin/docker-entrypoint.sh minio -C /root/.minio/ gateway gcs ${GOOGLE_PROJECT}
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: access_key
              name: swip-tools-minio
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: secret_key
              name: swip-tools-minio
        - name: MINIO_REGION
          value: us-central1
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /etc/gcs-credentials/credentials.json
        - name: GOOGLE_PROJECT
          value: polaris-dev-233821
        - name: MINIO_BROWSER
          value: "off"
        - emptyDir: {}
          name: minio-config-dir
        image: gcr.io/snps-swip-staging/public/minio/minio:RELEASE.2019-08-07T01-59-21Z
        name: report-storage
        ports:
        - containerPort: 9000
        resources:
          limits:
            cpu: 500m
            memory: 1024Mi
          requests:
            cpu: 250m
            memory: 256Mi
        volumeMounts:
        - mountPath: /root/.minio/
          name: minio-config-dir
        - mountPath: /etc/gcs-credentials
          name: gcs-credentials
          readOnly: true
      hostname: report-storage
      imagePullSecrets:
      - name: ${IMAGE_PULL_SECRETS}
      initContainers:
      - command:
        - migrate.sh
        env:
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: access_key
              name: swip-tools-minio
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: secret_key
              name: swip-tools-minio
        - name: MINIO_REGION
          value: us-central1
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /etc/gcs-credentials/credentials.json
        - name: GOOGLE_PROJECT
          value: polaris-dev-233821
        - name: MINIO_BROWSER
          value: "off"
        - emptyDir: {}
          name: minio-config-dir
        image: gcr.io/snps-swip-staging/rp-reports-pv-migrate:0.0.3
        imagePullPolicy: Always
        name: rp-storage-migrator
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /storage
          name: storage
        - mountPath: /etc/gcs-credentials
          name: gcs-credentials
          readOnly: true
      restartPolicy: Always
      volumes:
      - emptyDir: {}
        name: minio-config-dir
      - name: storage
        persistentVolumeClaim:
          claimName: report-storage-pv-claim
      - name: gcs-credentials
        secret:
          secretName: gcs-credentials
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    chartVersion: 0.0.1231
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    name: rp-report-service
    service: rp-report-service
  name: rp-report-service
  namespace: ${NAMESPACE}
spec:
  replicas: 1
  selector:
    matchLabels:
      environment: ${ENVIRONMENT_NAME}
      name: rp-report-service
  template:
    metadata:
      labels:
        environment: ${ENVIRONMENT_NAME}
        name: rp-report-service
    spec:
      containers:
      - env:
        - name: SWIP_VAULT_ADDRESS
          value: https://vault:8200
        - name: VAULT_CACERT
          value: /var/run/secrets/vault/ca/ca.crt
        - name: VAULT_CLIENT_KEY
          value: /var/run/secrets/vault/client/tls.key
        - name: VAULT_CLIENT_CERT
          value: /var/run/secrets/vault/client/tls.crt
        - name: POSTGRES_HOST
          valueFrom:
            configMapKeyRef:
              key: POSTGRESQL_HOST
              name: postgresql-config
        - name: POSTGRES_PORT
          valueFrom:
            configMapKeyRef:
              key: POSTGRESQL_PORT
              name: postgresql-config
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              key: POSTGRESQL_PASSWORD
              name: postgresql-config
        - name: POSTGRES_USERNAME
          valueFrom:
            secretKeyRef:
              key: POSTGRESQL_USER
              name: postgresql-config
        - name: CONNECTION_POOL_SIZE
          value: "10"
        - name: LOG_LEVEL
          value: INFO
        - name: SPRING_PROFILE
          value: production
        - name: SWIP_ENVIRONMENT_NAME
          value: ${ENVIRONMENT_NAME}
        - name: SWIP_ROOT_DOMAIN
          value: ${POLARIS_ROOT_DOMAIN}
        - name: REPORTING_STANDALONE
          value: <nil>
        - name: MINIO_BUCKET
          value: ${ENVIRONMENT_NAME}-rp-report-storage
        - name: MINIO_HOST
          value: report-storage
        - name: MINIO_PORT
          value: "9000"
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: access_key
              name: swip-tools-minio
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              key: secret_key
              name: swip-tools-minio
        - name: MINIO_REGION
          value: us-central1
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /etc/gcs-credentials/credentials.json
        - name: GOOGLE_PROJECT
          value: polaris-dev-233821
        - name: MINIO_BROWSER
          value: "off"
        - emptyDir: {}
          name: minio-config-dir
        - name: POSTGRES_SSL_MODE
          valueFrom:
            configMapKeyRef:
              key: POSTGRES_SSL_MODE
              name: postgresql-config
        - name: POSTGRES_SSL_CERTIFICATE_SOURCE
          value: file-system
        - name: POSTGRES_SSL_TRUST_STORE_PATH
          value: ""
        image: gcr.io/snps-swip-staging/reporting-report-service:0.0.1231
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /liveness
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 120
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 3
        name: rp-report-service
        ports:
        - containerPort: 8080
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /readiness
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 70
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        resources:
          limits:
            cpu: 750m
            memory: 1500Mi
          requests:
            cpu: 500m
            memory: 768Mi
        volumeMounts:
        - mountPath: /var/run/secrets/vault/client
          name: vault-client
          readOnly: true
        - mountPath: /var/run/secrets/vault/ca
          name: vault-server-ca
          readOnly: true
      - image: gcr.io/snps-swip-staging/reporting-clamav
        name: clamav
        ports:
        - containerPort: 3310
      imagePullSecrets:
      - name: ${IMAGE_PULL_SECRETS}
      initContainers:
      - args:
        - --http-readiness-check-urls=http://auth-server.$(POD_NAMESPACE).svc.cluster.local:80/readiness
        - --postgres-database=postgres
        - --postgres-host=$(POSTGRES_HOST)
        - --postgres-password=$(POSTGRESQL_PASSWORD)
        - --postgres-port=$(POSTGRES_PORT)
        - --postgres-user=$(POSTGRESQL_USER)
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POSTGRES_HOST
          valueFrom:
            configMapKeyRef:
              key: POSTGRESQL_HOST
              name: postgresql-config
        - name: POSTGRES_PORT
          valueFrom:
            configMapKeyRef:
              key: POSTGRESQL_PORT
              name: postgresql-config
        - name: POSTGRESQL_USER
          valueFrom:
            secretKeyRef:
              key: POSTGRESQL_USER
              name: postgresql-config
        - name: POSTGRESQL_PASSWORD
          valueFrom:
            secretKeyRef:
              key: POSTGRESQL_PASSWORD
              name: postgresql-config
        - name: POSTGRES_SSL_MODE
          valueFrom:
            configMapKeyRef:
              key: POSTGRES_SSL_MODE
              name: postgresql-config
        image: gcr.io/snps-swip-staging/polaris-init:1.0.0
        imagePullPolicy: Always
        name: polaris-init
      restartPolicy: Always
      volumes:
      - name: vault-client
        secret:
          secretName: vault-read-only
      - name: vault-server-ca
        secret:
          defaultMode: 420
          secretName: vault-tls-certificate-new
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    environment: ${ENVIRONMENT_NAME}
    name: report-storage
  name: report-storage-pv-claim
  namespace: ${NAMESPACE}
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: ${REPORT_STORAGE_PV_SIZE}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    chart: rp-tools-portfolio-service
    chartVersion: 0.0.1601
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    service: rp-tools-portfolio-service
  name: rp-tools-portfolio-service
  namespace: ${NAMESPACE}
---
apiVersion: v1
kind: Service
metadata:
  labels:
    environment: ${ENVIRONMENT_NAME}
  name: rp-tools-portfolio-service
  namespace: ${NAMESPACE}
spec:
  ports:
  - name: "8080"
    port: 8080
    targetPort: 8080
  selector:
    environment: ${ENVIRONMENT_NAME}
    name: rp-tools-portfolio-service
status:
  loadBalancer: {}
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    chart: rp-tools-portfolio-service
    chartVersion: 0.0.1601
    component: None
    componentVersion: None
    environment: ${ENVIRONMENT_NAME}
    name: rp-tools-portfolio-service
    service: rp-tools-portfolio-service
  name: rp-tools-portfolio-service
  namespace: ${NAMESPACE}
spec:
  replicas: 1
  selector:
    matchLabels:
      environment: ${ENVIRONMENT_NAME}
      name: rp-tools-portfolio-service
  template:
    metadata:
      labels:
        environment: ${ENVIRONMENT_NAME}
        name: rp-tools-portfolio-service
    spec:
      containers:
      - env:
        - name: EVENT_STORE_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: EVENT_STORE_READER_USERNAME
          value: reader
        - name: EVENT_STORE_READER_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: swip-eventstore-reader-creds
        - name: EVENT_STORE_ADDR
          value: eventstore.$(EVENT_STORE_NAMESPACE).svc.cluster.local
        - name: SWIP_VAULT_ADDRESS
          value: https://vault:8200
        - name: VAULT_CACERT
          value: /var/run/secrets/vault/ca/ca.crt
        - name: VAULT_CLIENT_KEY
          value: /var/run/secrets/vault/server/tls.key
        - name: VAULT_CLIENT_CERT
          value: /var/run/secrets/vault/server/tls.crt
        - name: POSTGRES_HOST
          valueFrom:
            configMapKeyRef:
              key: POSTGRESQL_HOST
              name: postgresql-config
        - name: POSTGRES_PORT
          valueFrom:
            configMapKeyRef:
              key: POSTGRESQL_PORT
              name: postgresql-config
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              key: POSTGRESQL_PASSWORD
              name: postgresql-config
        - name: POSTGRES_USERNAME
          valueFrom:
            secretKeyRef:
              key: POSTGRESQL_USER
              name: postgresql-config
        - name: CONNECTION_POOL_SIZE
          value: "10"
        - name: LOG_LEVEL
          value: INFO
        - name: SPRING_PROFILE
          value: production
        - name: SWIP_ENVIRONMENT_NAME
          value: ${ENVIRONMENT_NAME}
        - name: SWIP_ROOT_DOMAIN
          value: ${POLARIS_ROOT_DOMAIN}
        - name: REPORTING_STANDALONE
          value: "false"
        - name: POSTGRES_SSL_MODE
          value: disable
        - name: POSTGRES_SSL_CERTIFICATE_SOURCE
          value: file-system
        - name: POSTGRES_SSL_TRUST_STORE_PATH
          value: ""
        image: gcr.io/snps-swip-staging/reporting-tools-portfolio-service:0.0.1601
        imagePullPolicy: Always
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /liveness
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 140
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 3
        name: rp-tools-portfolio-service
        ports:
        - containerPort: 8080
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /readiness
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 90
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 3
        resources:
          limits:
            cpu: 750m
            memory: 1000Mi
          requests:
            cpu: 500m
            memory: 768Mi
        volumeMounts:
        - mountPath: /var/run/secrets/vault/server
          name: vault-server
          readOnly: true
        - mountPath: /var/run/secrets/vault/ca
          name: vault-server-ca
          readOnly: true
      imagePullSecrets:
      - name: ${IMAGE_PULL_SECRETS}
      restartPolicy: Always
      serviceAccount: auth-server
      volumes:
      - name: vault-server
        secret:
          secretName: vault-read-write-auth
      - name: vault-server-ca
        secret:
          defaultMode: 420
          secretName: vault-tls-certificate-new
